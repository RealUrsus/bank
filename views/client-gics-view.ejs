<!doctype html>
<html lang="en">
  <head>
    <%- include('partials/head'); %>
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/client-common.css">
  </head>
  <body>
    <header>
      <%- include('partials/header'); %>
    </header>
    <main class="container-fluid d-flex flex-nowrap">
      <aside class="border">
        <%- include('partials/client/sidebar'); %>
      </aside>
      <!-- Content -->
      <div class="flex-grow-1 p-3">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3 class="mb-0">My GIC Investments</h3>
        </div>

        <!-- GICs Table -->
        <div class="table-responsive mt-4">
          <% if (gics && gics.length > 0) { %>
          <table class="table table-hover align-middle" id="gicsTable">
            <thead class="table-light">
              <tr>
                <th class="sortable" data-column="accountId">
                  Account ID <i data-feather="chevrons-up-down" style="width: 14px; height: 14px;"></i>
                </th>
                <th class="sortable" data-column="productName">
                  Product Name <i data-feather="chevrons-up-down" style="width: 14px; height: 14px;"></i>
                </th>
                <th class="sortable" data-column="principal">
                  Principal Amount <i data-feather="chevrons-up-down" style="width: 14px; height: 14px;"></i>
                </th>
                <th class="sortable" data-column="rate">
                  Rate <i data-feather="chevrons-up-down" style="width: 14px; height: 14px;"></i>
                </th>
                <th class="sortable" data-column="term">
                  Term <i data-feather="chevrons-up-down" style="width: 14px; height: 14px;"></i>
                </th>
                <th class="sortable" data-column="startDate">
                  Start Date <i data-feather="chevrons-up-down" style="width: 14px; height: 14px;"></i>
                </th>
                <th class="sortable" data-column="endDate">
                  End Date <i data-feather="chevrons-up-down" style="width: 14px; height: 14px;"></i>
                </th>
                <th class="sortable" data-column="maturity">
                  Balance at Maturity <i data-feather="chevrons-up-down" style="width: 14px; height: 14px;"></i>
                </th>
              </tr>
            </thead>
            <tbody id="gicsTableBody">
              <% for (const gic of gics) {
                const principal = parseFloat(gic.PrincipalAmount);
                const rate = parseFloat(gic.InterestRate);
                const term = parseInt(gic.Term);
                const balanceAtMaturity = principal + (principal * rate / 100 * term / 12);

                // Parse date as local to avoid timezone conversion issues
                const [year, month, day] = gic.StartDate.split('-').map(Number);
                const startDate = new Date(year, month - 1, day);
                const endDate = new Date(startDate);
                endDate.setMonth(endDate.getMonth() + term);
                const formattedEndDate = endDate.toISOString().split('T')[0];
              %>
              <tr class="clickable-row"
                  onclick="window.location.href='/client/gic/view/<%= gic.AccountID %>'"
                  data-account-id="<%= gic.AccountID %>"
                  data-product-name="<%= gic.ProductName || 'N/A' %>"
                  data-principal="<%= principal %>"
                  data-rate="<%= rate %>"
                  data-term="<%= term %>"
                  data-start-date="<%= gic.StartDate %>"
                  data-end-date="<%= formattedEndDate %>"
                  data-maturity="<%= balanceAtMaturity %>">
                <td>
                  <a href="/client/gic/view/<%= gic.AccountID %>" class="fw-bold text-decoration-none">
                    #<%= gic.AccountID %>
                  </a>
                </td>
                <td>
                  <a href="/client/gic/view/<%= gic.AccountID %>" class="text-decoration-none">
                    <%= gic.ProductName || 'N/A' %>
                  </a>
                </td>
                <td>$<%= principal.toFixed(2) %></td>
                <td><%= gic.InterestRate %>%</td>
                <td><%= gic.Term %> months</td>
                <td><%= gic.StartDate %></td>
                <td><%= formattedEndDate %></td>
                <td>$<%= balanceAtMaturity.toFixed(2) %></td>
              </tr>
              <% } %>
            </tbody>
          </table>
          <% } else { %>
          <!-- Empty State -->
          <div class="text-center py-5">
            <i data-feather="briefcase" style="width: 64px; height: 64px;" class="text-muted mb-3"></i>
            <h4 class="text-muted">No GIC Investments Found</h4>
            <p class="text-muted">You don't have any GIC investments yet.</p>
          </div>
          <% } %>
        </div>
      </div>
    </main>
    <footer>
      <%- include('partials/footer'); %>
    </footer>
    <script src="/js/feather.min.js"></script>
    <script>
      feather.replace();

      // Sorting functionality
      const tbody = document.getElementById("gicsTableBody");
      const headers = document.querySelectorAll(".sortable");
      let sortDirection = {};

      headers.forEach(header => {
        const column = header.getAttribute("data-column");
        sortDirection[column] = 'asc';

        header.addEventListener("click", function() {
          // Toggle sort direction
          sortDirection[column] = sortDirection[column] === 'asc' ? 'desc' : 'asc';
          const direction = sortDirection[column];

          // Get rows and sort
          const rows = Array.from(tbody.querySelectorAll("tr"));

          rows.sort((a, b) => {
            let aValue, bValue;

            switch(column) {
              case "accountId":
                aValue = parseInt(a.getAttribute("data-account-id"));
                bValue = parseInt(b.getAttribute("data-account-id"));
                break;
              case "productName":
                aValue = a.getAttribute("data-product-name").toLowerCase();
                bValue = b.getAttribute("data-product-name").toLowerCase();
                break;
              case "principal":
              case "rate":
              case "term":
              case "maturity":
                aValue = parseFloat(a.getAttribute("data-" + column));
                bValue = parseFloat(b.getAttribute("data-" + column));
                break;
              case "startDate":
              case "endDate":
                aValue = new Date(a.getAttribute("data-" + column.replace(/([A-Z])/g, '-$1').toLowerCase()));
                bValue = new Date(b.getAttribute("data-" + column.replace(/([A-Z])/g, '-$1').toLowerCase()));
                break;
              default:
                return 0;
            }

            if (aValue < bValue) return direction === 'asc' ? -1 : 1;
            if (aValue > bValue) return direction === 'asc' ? 1 : -1;
            return 0;
          });

          // Re-append rows in sorted order
          rows.forEach(row => tbody.appendChild(row));

          // Update header icons
          document.querySelectorAll('.sortable i').forEach(icon => {
            icon.setAttribute('data-feather', 'chevrons-up-down');
          });
          const icon = header.querySelector('i');
          icon.setAttribute('data-feather', direction === 'asc' ? 'chevron-up' : 'chevron-down');
          feather.replace();
        });
      });
    </script>
  </body>
</html>
