<!doctype html>
<html lang="en">
  <head>
    <%- include('partials/head'); %>
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/client-common.css">
  </head>
  <body>
    <header>
      <%- include('partials/header'); %>
    </header>
    <main class="container-fluid d-flex flex-nowrap">
      <aside class="border">
        <%- include('partials/client/sidebar'); %>
      </aside>
      <!-- Content -->
      <div class="flex-grow-1 p-3">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3 class="mb-0">My Loans</h3>
        </div>

        <!-- Summary Section -->
        <% if (loans && loans.length > 0) { %>
        <div class="summary-card shadow-sm">
          <div class="row">
            <div class="col-md-3 summary-metric">
              <div class="summary-metric-value"><%= loans.length %></div>
              <div class="summary-metric-label">Total Loans</div>
            </div>
            <div class="col-md-3 summary-metric">
              <div class="summary-metric-value">$<%= loans.reduce((sum, l) => sum + l.PrincipalAmount, 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></div>
              <div class="summary-metric-label">Total Principal</div>
            </div>
            <div class="col-md-3 summary-metric">
              <div class="summary-metric-value"><%= (loans.reduce((sum, l) => sum + l.InterestRate, 0) / loans.length).toFixed(2) %>%</div>
              <div class="summary-metric-label">Average Rate</div>
            </div>
            <div class="col-md-3 summary-metric">
              <div class="summary-metric-value"><%= Math.round(loans.reduce((sum, l) => sum + l.Term, 0) / loans.length) %></div>
              <div class="summary-metric-label">Average Term (months)</div>
            </div>
          </div>
        </div>
        <% } %>

        <!-- Status Filter Button Group -->
        <div class="mb-3">
          <label class="form-label fw-bold">Filter by Status:</label>
          <div class="btn-group d-block" role="group" aria-label="Status filter">
            <input type="radio" class="btn-check" name="statusFilter" id="filter-active" value="active" <%= selectedStatus === 'active' ? 'checked' : '' %>>
            <label class="btn btn-outline-success" for="filter-active">
              <i data-feather="activity" style="width: 16px; height: 16px;"></i> Active
            </label>

            <input type="radio" class="btn-check" name="statusFilter" id="filter-all" value="all" <%= selectedStatus === 'all' ? 'checked' : '' %>>
            <label class="btn btn-outline-primary" for="filter-all">
              <i data-feather="list" style="width: 16px; height: 16px;"></i> All
            </label>

            <input type="radio" class="btn-check" name="statusFilter" id="filter-pending" value="pending" <%= selectedStatus === 'pending' ? 'checked' : '' %>>
            <label class="btn btn-outline-warning" for="filter-pending">
              <i data-feather="clock" style="width: 16px; height: 16px;"></i> Pending
            </label>

            <input type="radio" class="btn-check" name="statusFilter" id="filter-paid-off" value="paid off" <%= selectedStatus === 'paid off' ? 'checked' : '' %>>
            <label class="btn btn-outline-info" for="filter-paid-off">
              <i data-feather="check-square" style="width: 16px; height: 16px;"></i> Paid Off
            </label>

            <input type="radio" class="btn-check" name="statusFilter" id="filter-rejected" value="rejected" <%= selectedStatus === 'rejected' ? 'checked' : '' %>>
            <label class="btn btn-outline-danger" for="filter-rejected">
              <i data-feather="x-circle" style="width: 16px; height: 16px;"></i> Rejected
            </label>

            <input type="radio" class="btn-check" name="statusFilter" id="filter-closed" value="closed" <%= selectedStatus === 'closed' ? 'checked' : '' %>>
            <label class="btn btn-outline-secondary" for="filter-closed">
              <i data-feather="x-square" style="width: 16px; height: 16px;"></i> Closed
            </label>
          </div>
        </div>

        <!-- Search Box -->
        <div class="mb-3 search-box">
          <div class="input-group">
            <span class="input-group-text bg-white">
              <i data-feather="search" style="width: 16px; height: 16px;"></i>
            </span>
            <input type="text" class="form-control" id="searchLoans" placeholder="Search by loan ID, description, or amount...">
          </div>
        </div>
        <!-- Loans Table -->
        <div class="table-responsive mt-4">
          <% if (loans && loans.length > 0) { %>
          <table class="table table-hover align-middle" id="loansTable">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Principal Amount</th>
                <th>Rate</th>
                <th>Term</th>
                <th>Start Date</th>
                <th>Maturity Date</th>
                <th>Description</th>
                <th class="text-center">Status</th>
              </tr>
            </thead>
            <tbody>
              <% for (const loan of loans) {
                // Parse date as local to avoid timezone conversion issues
                const [year, month, day] = loan.StartDate.split('-').map(Number);
                const startDate = new Date(year, month - 1, day);
                const endDate = new Date(startDate);
                endDate.setMonth(endDate.getMonth() + parseInt(loan.Term));
                const formattedStartDate = startDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                const formattedEndDate = endDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                const statusClass = loan.StatusName ? 'status-' + loan.StatusName.toLowerCase().replace(/\s+/g, '-') : '';
              %>
              <tr class="loan-row" onclick="window.location.href='/client/loan/view/<%= loan.AccountID %>'">
                <td>
                  <a href="/client/loan/view/<%= loan.AccountID %>" class="fw-bold text-decoration-none">
                    #<%= loan.AccountID %>
                  </a>
                </td>
                <td class="fw-bold text-primary">
                  $<%= loan.PrincipalAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                </td>
                <td><%= loan.InterestRate %>%</td>
                <td><%= loan.Term %> months</td>
                <td><%= formattedStartDate %></td>
                <td><%= formattedEndDate %></td>
                <td><%= loan.Description || 'Personal Loan' %></td>
                <td class="text-center">
                  <span class="status-badge <%= statusClass %>">
                    <%= loan.StatusName %>
                  </span>
                </td>
              </tr>
              <% } %>
            </tbody>
          </table>
          <% } else { %>
          <!-- Empty State -->
          <div class="text-center py-5">
            <i data-feather="file-text" style="width: 64px; height: 64px;" class="text-muted mb-3"></i>
            <h4 class="text-muted">No Loans Found</h4>
            <p class="text-muted">You don't have any loans with status: <strong><%= selectedStatus %></strong></p>
            <% if (selectedStatus !== 'all') { %>
            <button class="btn btn-primary" onclick="window.location.href='/client/loan/view?status=all'">
              View All Loans
            </button>
            <% } %>
          </div>
          <% } %>
        </div>
      </div>
    </main>
    <footer>
      <%- include('partials/footer'); %>
    </footer>
    <script src="/js/feather.min.js"></script>
    <script>
      feather.replace();

      // Status filter button group navigation
      document.querySelectorAll('input[name="statusFilter"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          window.location.href = '/client/loan/view?status=' + e.target.value;
        });
      });

      // Search functionality
      const searchInput = document.getElementById('searchLoans');
      const loansTable = document.getElementById('loansTable');

      if (searchInput && loansTable) {
        searchInput.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const rows = loansTable.querySelectorAll('tbody tr');
          let visibleCount = 0;

          rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const isVisible = text.includes(searchTerm);
            row.style.display = isVisible ? '' : 'none';
            if (isVisible) visibleCount++;
          });

          // Show "no results" message if no rows match
          const existingNoResults = document.getElementById('noSearchResults');
          if (existingNoResults) {
            existingNoResults.remove();
          }

          if (visibleCount === 0 && searchTerm !== '') {
            const noResults = document.createElement('div');
            noResults.id = 'noSearchResults';
            noResults.className = 'alert alert-info text-center mt-3';
            noResults.innerHTML = '<i data-feather="search" style="width: 24px; height: 24px;"></i><br>No loans match your search term: <strong>' + searchTerm + '</strong>';
            loansTable.parentElement.appendChild(noResults);
            feather.replace();
          }
        });
      }

      // Add click handler for table rows (in case onclick doesn't work in some browsers)
      document.querySelectorAll('.loan-row').forEach(row => {
        row.style.cursor = 'pointer';
      });
    </script>
  </body>
</html>