<!doctype html>
<html lang="en">
  <head>
    <%- include('partials/head'); %>
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/client-common.css">
  </head>
  <body>
    <header>
      <%- include('partials/header'); %>
    </header>
		<main class="container-fluid d-flex flex-nowrap">
			<aside class="border">
				<%- include('partials/client/sidebar'); %>
			</aside>
        <!-- Content -->
        <div class="flex-grow-1 p-3">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="mb-0">My Agreements</h3>
          </div>

          <!-- Search Box -->
          <div class="mb-3 search-box">
            <div class="input-group">
              <span class="input-group-text bg-white">
                <i data-feather="search" style="width: 16px; height: 16px;"></i>
              </span>
              <input type="text" class="form-control" id="searchAgreements" placeholder="Search by agreement name or ID...">
            </div>
          </div>

          <!-- Agreements Table -->
          <div class="table-responsive mt-4">
            <% if (agreements && agreements.length > 0) { %>
            <table class="table table-hover align-middle" id="agreementsTable">
              <thead class="table-light">
                <tr>
                  <th class="sortable" data-column="agreementId">
                    Agreement ID <i data-feather="chevrons-up-down" style="width: 14px; height: 14px;"></i>
                  </th>
                  <th class="sortable" data-column="agreementName">
                    Agreement Name <i data-feather="chevrons-up-down" style="width: 14px; height: 14px;"></i>
                  </th>
                  <th class="sortable text-center" data-column="status">
                    Status <i data-feather="chevrons-up-down" style="width: 14px; height: 14px;"></i>
                  </th>
                </tr>
              </thead>
              <tbody id="agreementsTableBody">
                <% agreements.forEach(agreement => {
                  const statusClass = agreement.StatusName ? 'status-' + agreement.StatusName.toLowerCase().replace(/\s+/g, '-') : '';
                %>
                <tr class="clickable-row"
                    onclick="window.location.href='/client/agreements/<%= agreement.AgreementID%>'"
                    data-agreement-id="<%= agreement.AgreementID %>"
                    data-agreement-name="<%= agreement.AgreementName %>"
                    data-status="<%= agreement.StatusName %>">
                  <td>
                    <a href="/client/agreements/<%= agreement.AgreementID%>" class="fw-bold text-decoration-none">
                      #<%= agreement.AgreementID %>
                    </a>
                  </td>
                  <td>
                    <a href="/client/agreements/<%= agreement.AgreementID%>" class="text-decoration-none">
                      <%= agreement.AgreementName %>
                    </a>
                  </td>
                  <td class="text-center">
                    <span class="status-badge <%= statusClass %>">
                      <%= agreement.StatusName %>
                    </span>
                  </td>
                </tr>
                <% }) %>
              </tbody>
            </table>
            <% } else { %>
            <!-- Empty State -->
            <div class="text-center py-5">
              <i data-feather="file-text" style="width: 64px; height: 64px;" class="text-muted mb-3"></i>
              <h4 class="text-muted">No Agreements Found</h4>
              <p class="text-muted">You currently have no agreements in the system.</p>
            </div>
            <% } %>
          </div>
        </div>
    </main>

    <footer>
      <%- include('partials/footer'); %>
    </footer>
    <script src="/js/feather.min.js"></script>
    <script>
      feather.replace();

      // Search functionality
      const searchInput = document.getElementById('searchAgreements');
      const agreementsTable = document.getElementById('agreementsTable');

      if (searchInput && agreementsTable) {
        searchInput.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const rows = agreementsTable.querySelectorAll('tbody tr');
          let visibleCount = 0;

          rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const isVisible = text.includes(searchTerm);
            row.style.display = isVisible ? '' : 'none';
            if (isVisible) visibleCount++;
          });

          // Show "no results" message if no rows match
          const existingNoResults = document.getElementById('noSearchResults');
          if (existingNoResults) {
            existingNoResults.remove();
          }

          if (visibleCount === 0 && searchTerm !== '') {
            const noResults = document.createElement('div');
            noResults.id = 'noSearchResults';
            noResults.className = 'alert alert-info text-center mt-3';
            noResults.innerHTML = '<i data-feather="search" style="width: 24px; height: 24px;"></i><br>No agreements match your search term: <strong>' + searchTerm + '</strong>';
            agreementsTable.parentElement.appendChild(noResults);
            feather.replace();
          }
        });
      }

      // Sorting functionality
      const tbody = document.getElementById("agreementsTableBody");
      const headers = document.querySelectorAll(".sortable");
      let sortDirection = {};

      headers.forEach(header => {
        const column = header.getAttribute("data-column");
        sortDirection[column] = 'asc';

        header.addEventListener("click", function() {
          // Toggle sort direction
          sortDirection[column] = sortDirection[column] === 'asc' ? 'desc' : 'asc';
          const direction = sortDirection[column];

          // Get rows and sort
          const rows = Array.from(tbody.querySelectorAll("tr"));

          rows.sort((a, b) => {
            let aValue, bValue;

            switch(column) {
              case "agreementId":
                aValue = parseInt(a.getAttribute("data-agreement-id"));
                bValue = parseInt(b.getAttribute("data-agreement-id"));
                break;
              case "agreementName":
                aValue = a.getAttribute("data-agreement-name").toLowerCase();
                bValue = b.getAttribute("data-agreement-name").toLowerCase();
                break;
              case "status":
                aValue = a.getAttribute("data-status").toLowerCase();
                bValue = b.getAttribute("data-status").toLowerCase();
                break;
              default:
                return 0;
            }

            if (aValue < bValue) return direction === 'asc' ? -1 : 1;
            if (aValue > bValue) return direction === 'asc' ? 1 : -1;
            return 0;
          });

          // Re-append rows in sorted order
          rows.forEach(row => tbody.appendChild(row));

          // Update header icons
          document.querySelectorAll('.sortable i').forEach(icon => {
            icon.setAttribute('data-feather', 'chevrons-up-down');
          });
          const icon = header.querySelector('i');
          icon.setAttribute('data-feather', direction === 'asc' ? 'chevron-up' : 'chevron-down');
          feather.replace();
        });
      });
    </script>
  </body>
</html>