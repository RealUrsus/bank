<!doctype html>
<html lang="en">
	<head>
		<%- include('partials/head'); %>
		<link rel="stylesheet" href="/css/sidebar.css">
	</head>
	<body>
		<header>
			<%- include('partials/header'); %>
		</header>

		<main class="container-fluid d-flex flex-nowrap">
			<aside class="border">
				<%- include('partials/admin/sidebar'); %>
			</aside>
        <!-- Content -->
        <div class="flex-grow-1 p-5">
          <% if (agreements && agreements.length > 0) { %>
          <input class="form-control mb-3" id="myInput" type="text" placeholder="Search..">

          <%
            // Group agreements by client
            const clientGroups = {};
            agreements.forEach(agreement => {
              const clientKey = `${agreement.Name} ${agreement.Surname}`;
              const clientId = agreement.ClientID || clientKey;
              if (!clientGroups[clientId]) {
                clientGroups[clientId] = {
                  name: agreement.Name,
                  surname: agreement.Surname,
                  agreements: []
                };
              }
              clientGroups[clientId].agreements.push(agreement);
            });

            const clientKeys = Object.keys(clientGroups).sort((a, b) => {
              const nameA = `${clientGroups[a].name} ${clientGroups[a].surname}`.toLowerCase();
              const nameB = `${clientGroups[b].name} ${clientGroups[b].surname}`.toLowerCase();
              return nameA.localeCompare(nameB);
            });
          %>

          <div class="accordion" id="clientAgreementsAccordion">
            <% clientKeys.forEach((clientId, index) => {
              const client = clientGroups[clientId];
              const collapseId = `collapse-${index}`;
            %>
              <div class="accordion-item mb-3" data-client-name="<%= client.name.toLowerCase() %> <%= client.surname.toLowerCase() %>">
                <h2 class="accordion-header" id="heading-<%= index %>">
                  <button class="accordion-button <%= index !== 0 ? 'collapsed' : '' %>" type="button" data-bs-toggle="collapse" data-bs-target="#<%= collapseId %>" aria-expanded="<%= index === 0 ? 'true' : 'false' %>" aria-controls="<%= collapseId %>">
                    <strong><%= client.name %> <%= client.surname %></strong>
                    <span class="badge bg-primary ms-2"><%= client.agreements.length %> agreement<%= client.agreements.length !== 1 ? 's' : '' %></span>
                  </button>
                </h2>
                <div id="<%= collapseId %>" class="accordion-collapse collapse <%= index === 0 ? 'show' : '' %>" aria-labelledby="heading-<%= index %>" data-bs-parent="#clientAgreementsAccordion">
                  <div class="accordion-body p-0">
                    <table class="table table-bordered table-striped mb-0">
                      <thead>
                        <tr>
                          <th>Agreement</th>
                          <th>Status</th>
                          <th style="width: 200px; text-align: center;">Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% client.agreements.forEach(agreement => { %>
                          <tr>
                            <td><%= agreement.AgreementName %></td>
                            <td>
                              <% if (agreement.StatusName === 'Active') { %>
                                <span class="badge bg-success"><%= agreement.StatusName %></span>
                              <% } else if (agreement.StatusName === 'Pending') { %>
                                <span class="badge bg-warning text-dark"><%= agreement.StatusName %></span>
                              <% } else if (agreement.StatusName === 'Closed' || agreement.StatusName === 'Cancelled') { %>
                                <span class="badge bg-secondary"><%= agreement.StatusName %></span>
                              <% } else { %>
                                <span class="badge bg-info text-dark"><%= agreement.StatusName %></span>
                              <% } %>
                            </td>
                            <td class="text-center">
                              <div class="btn-group" role="group">
                                <a href="/admin/agreements/edit/<%= agreement.AgreementID %>" class="btn btn-primary btn-sm">Edit</a>
                                <form action="/admin/agreements/delete" method="POST" class="d-inline">
                                  <input type="hidden" name="id" value="<%= agreement.AgreementID %>">
                                  <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this agreement?')">Delete</button>
                                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                </form>
                              </div>
                            </td>
                          </tr>
                        <% }) %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            <% }) %>
          </div>
          <% } else { %>
          <div class="alert alert-info" role="alert">
            <h5 class="alert-heading">No agreements found</h5>
            <p>There are currently no agreements in the system.</p>
          </div>
          <% } %>
        </div>
              
          <script>
            document.addEventListener("DOMContentLoaded", function() {
              var input = document.getElementById("myInput");
              var debounceTimer;

              input.addEventListener("keyup", function() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(function() {
                  var filter = input.value.toLowerCase();
                  var accordionItems = document.querySelectorAll(".accordion-item");
                  var hasVisibleResults = false;

                  accordionItems.forEach(function(item) {
                    var clientName = item.getAttribute("data-client-name") || "";
                    var rows = item.querySelectorAll("tbody tr");
                    var hasVisibleRows = false;

                    // Check if client name matches
                    var clientMatches = !filter || clientName.includes(filter);

                    rows.forEach(function(row) {
                      var text = row.textContent.toLowerCase();
                      var rowMatches = !filter || text.includes(filter);
                      var shouldShow = clientMatches || rowMatches;
                      row.style.display = shouldShow ? "" : "none";
                      if (shouldShow) {
                        hasVisibleRows = true;
                      }
                    });

                    // Show/hide entire accordion item based on matches
                    item.style.display = (clientMatches || hasVisibleRows) ? "" : "none";

                    if (clientMatches || hasVisibleRows) {
                      hasVisibleResults = true;
                      // Expand accordion if there's a filter and it has matches
                      if (filter) {
                        var collapse = item.querySelector(".accordion-collapse");
                        if (collapse && !collapse.classList.contains("show")) {
                          var bsCollapse = new bootstrap.Collapse(collapse, { show: true });
                        }
                      }
                    }
                  });
                }, 200);
              });
            });
          </script>
    </main>
		  
		<footer>
			<%- include('partials/footer'); %>
		</footer>

    <!-- Icons -->
    <script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
    <script>
      feather.replace()
    </script>
	</body>
</html>