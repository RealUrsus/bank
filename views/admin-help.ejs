<!doctype html>
<html lang="en">
	<head>
		<%- include('partials/head'); %>
		<link rel="stylesheet" href="/css/sidebar.css">
		<style>
			.help-section {
				margin-bottom: 2rem;
				padding: 1.5rem;
				background-color: #f8f9fa;
				border-left: 4px solid #0d6efd;
				border-radius: 0.25rem;
			}
			.help-section h3 {
				color: #0d6efd;
				margin-bottom: 1rem;
			}
			.help-section h4 {
				color: #495057;
				margin-top: 1.5rem;
				margin-bottom: 0.75rem;
			}
			.process-step {
				margin-left: 1rem;
				padding: 0.5rem 0;
			}
			.code-block {
				background-color: #e9ecef;
				padding: 0.75rem;
				border-radius: 0.25rem;
				font-family: monospace;
				margin: 0.5rem 0;
			}
			.alert-process {
				margin: 1rem 0;
				padding: 1rem;
				border-radius: 0.25rem;
			}
		</style>
	</head>
	<body>
		<header>
			<%- include('partials/header'); %>
		</header>

		<main class="container-fluid d-flex flex-nowrap">
			<aside class="border">
				<%- include('partials/admin/sidebar'); %>
			</aside>
			<!-- Content -->
			<div class="p-5 w-100">
				<h2 class="mb-4"><i data-feather="help-circle"></i> Admin Help - Daily Processes</h2>
				<p class="lead">This page provides documentation for daily processes, loan and investment management, and maturity handling.</p>

				<!-- Loan Approval Section -->
				<div class="help-section">
					<h3><i data-feather="check-square"></i> Loan Approval and Disbursement Process</h3>
					<p>The loan process follows these steps:</p>

					<div class="process-step">
						<p><strong>Step 1: Admin Approves Loan</strong></p>
						<ul>
							<li>Admin reviews loan request and clicks "Approve"</li>
							<li>System updates loan status to <span class="badge bg-success">Active</span></li>
							<li>Logs <code>LOAN_APPROVED</code> event to <code>./var/log/loans.log</code></li>
							<li><strong>No funds disbursed yet</strong> - funds will be disbursed on the start date</li>
						</ul>

						<p class="mt-3"><strong>Step 2: Daily Tasks Disburse Funds on Start Date</strong></p>
						<ul>
							<li>Daily tasks run at <strong>midnight (system time)</strong></li>
							<li>System checks all Active loans</li>
							<li>For loans where yesterday was the start date and not yet disbursed:
								<ul>
									<li>Deposits loan principal to client's chequing account</li>
									<li>Creates system transaction: "Loan disbursement - Loan #[ID]"</li>
									<li>Logs <code>LOAN_DISBURSED</code> event to <code>./var/log/loans.log</code></li>
									<li>Loan becomes active and begins accruing interest</li>
								</ul>
							</li>
						</ul>

						<p class="mt-3"><strong>Step 3: Interest Payments Begin</strong></p>
						<ul>
							<li>After disbursement, interest payments process based on payment frequency</li>
							<li>Monthly or annual withdrawals from chequing account</li>
						</ul>

						<div class="alert alert-info alert-process">
							<strong>Example Timeline:</strong><br>
							<strong>Day 1 (Jan 10):</strong> Client requests $10,000 loan with start date Jan 15<br>
							<strong>Day 2 (Jan 11):</strong> Admin approves → Status = Active, no funds yet<br>
							<strong>Day 6 (Jan 16 at midnight):</strong> Daily tasks run → $10,000 deposited to chequing (funds disbursed the day after start date)<br>
							<strong>Feb 15:</strong> First interest payment withdrawn (if Monthly frequency)<br>
						</div>

						<div class="alert alert-warning alert-process">
							<strong>Important:</strong> Admins can approve loans in advance. The funds will be disbursed at midnight on the day after the start date (e.g., start date Jan 15 → disbursed Jan 16 at midnight).
						</div>
					</div>
				</div>

				<!-- Daily Automated Tasks Section -->
				<div class="help-section">
					<h3><i data-feather="clock"></i> Daily Automated Tasks</h3>
					<p>The system runs automated tasks every day at <strong>midnight UTC (12:00 AM)</strong> to process loan disbursements, interest payments, and check maturity status for all accounts.</p>

					<h4>1. Loan Disbursement</h4>
					<div class="process-step">
						<p><strong>Process:</strong> <code>disburseLoanFunds()</code></p>
						<p><strong>Frequency:</strong> Daily at midnight (first task)</p>
						<p><strong>What happens:</strong></p>
						<ul>
							<li>System retrieves all <span class="badge bg-success">Active</span> loans</li>
							<li>For each loan:
								<ul>
									<li>Checks if yesterday was the start date</li>
									<li>Checks if funds have already been disbursed</li>
									<li>If eligible, deposits principal to client's chequing account</li>
								</ul>
							</li>
							<li>Creates a <span class="badge bg-success">DEPOSIT</span> system transaction</li>
							<li>Transaction description: "Loan disbursement - Loan #[ID]"</li>
						</ul>
						<div class="alert alert-success alert-process">
							<strong>Note:</strong> This ensures approved loans are automatically funded the day after their start date without manual intervention.
						</div>
					</div>

					<h4>2. Loan Interest Processing</h4>
					<div class="process-step">
						<p><strong>Process:</strong> <code>processLoanInterest()</code></p>
						<p><strong>Frequency:</strong> Daily at midnight (processes payments on due dates only)</p>
						<p><strong>What happens:</strong></p>
						<ul>
							<li>System retrieves all <span class="badge bg-success">Active</span> loans</li>
							<li>For each loan, checks if an interest payment is due based on <strong>Payment Frequency</strong>:
								<ul>
									<li><strong>Monthly:</strong> Payment due on the same day each month (e.g., loan starts Jan 15 → payments on Feb 15, Mar 15, etc.)</li>
									<li><strong>Annual:</strong> Payment due on the same date each year (e.g., Jan 15, 2024 → Jan 15, 2025)</li>
								</ul>
							</li>
							<li>If payment is due, calculates interest amount:
								<ul>
									<li><strong>Monthly:</strong> <code>(Principal × Annual Rate / 100) / 12</code></li>
									<li><strong>Annual:</strong> <code>Principal × Annual Rate / 100</code></li>
								</ul>
							</li>
							<li>Creates a <span class="badge bg-danger">WITHDRAWAL</span> from client's <strong>chequing account</strong> for the interest amount</li>
							<li>Transaction is marked as <span class="badge bg-secondary">SYSTEM</span> and automatically approved</li>
						</ul>
						<div class="alert alert-info alert-process">
							<strong>Example:</strong> Loan of $10,000 at 5% APR with Monthly payment frequency<br>
							Start date: January 15, 2024<br>
							Monthly interest = ($10,000 × 5 / 100) / 12 = $41.67<br>
							Payments withdrawn on: Feb 15, Mar 15, Apr 15, etc.
						</div>
					</div>

					<h4>3. Loan Payoff Checks</h4>
					<div class="process-step">
						<p><strong>Process:</strong> <code>checkLoanPayoffs()</code></p>
						<p><strong>Frequency:</strong> Daily at midnight</p>
						<p><strong>What happens:</strong></p>
						<ul>
							<li>System checks if loan balance ≥ principal amount</li>
							<li>If condition is met, loan status changes to <span class="badge bg-success">PAID_OFF</span></li>
							<li>Loan stops processing interest payments once marked as paid off</li>
						</ul>
						<div class="alert alert-success alert-process">
							<strong>Note:</strong> Clients must make deposits to their loan account to pay it off. Once the total deposits equal or exceed the principal, the loan is automatically marked as paid off.
						</div>
					</div>

					<h4>4. Loan Maturity Processing</h4>
					<div class="process-step">
						<p><strong>Process:</strong> <code>checkLoanMaturity()</code></p>
						<p><strong>Frequency:</strong> Daily at midnight</p>
						<p><strong>What happens:</strong></p>
						<ul>
							<li>System checks if current date ≥ (start date + term in months)</li>
							<li>For matured loans, the system automatically:
								<ol>
									<li>Logs <code>LOAN_MATURITY</code> event to <code>./var/log/loans.log</code></li>
									<li>Calculates remaining unpaid balance (Principal - Amount Paid)</li>
									<li>Withdraws remaining balance from client's chequing account as final payment</li>
									<li>Updates loan status to <span class="badge bg-secondary">CLOSED</span></li>
									<li>Logs <code>LOAN_CLOSED</code> event</li>
								</ol>
							</li>
							<li>30-day notification appears on admin dashboard for loans nearing maturity</li>
						</ul>
						<div class="alert alert-warning alert-process">
							<strong>Important:</strong> At maturity, the system automatically withdraws any remaining unpaid balance from the client's chequing account and closes the loan. Ensure clients have sufficient funds before maturity date.
						</div>
					</div>

					<h4>5. GIC Maturity Processing</h4>
					<div class="process-step">
						<p><strong>Process:</strong> <code>checkGICMaturity()</code></p>
						<p><strong>Frequency:</strong> Daily at midnight</p>
						<p><strong>What happens:</strong></p>
						<ul>
							<li>System checks if current date ≥ maturity date for each GIC</li>
							<li>If matured, automatically processes the GIC (see next section for details)</li>
							<li>30-day notification appears on admin dashboard for GICs nearing maturity</li>
						</ul>
						<div class="alert alert-info alert-process">
							<strong>Note:</strong> GICs do NOT process interest on a daily basis. Interest is calculated using compound interest formula only at maturity.
						</div>
					</div>
				</div>

				<!-- Maturity Actions Section -->
				<div class="help-section">
					<h3><i data-feather="calendar"></i> Actions at Maturity</h3>

					<h4>Loan Maturity Process (Fully Automated)</h4>
					<div class="process-step">
						<p><strong>When:</strong> Start Date + Term (in months) = Maturity Date</p>
						<p><strong>Automatic Actions:</strong></p>
						<ol>
							<li>System logs maturity event to <code>./var/log/loans.log</code> with:
								<ul>
									<li>Loan ID and user details</li>
									<li>Principal amount</li>
									<li>Balance paid so far</li>
									<li>Remaining balance owed</li>
								</ul>
							</li>
							<li>Calculates remaining unpaid balance:
								<div class="code-block">
									Remaining = Principal Amount - Balance Paid
								</div>
							</li>
							<li>Withdraws remaining balance from client's <strong>chequing account</strong> as final payment</li>
							<li>Updates loan status to <span class="badge bg-secondary">CLOSED</span></li>
							<li>Logs closure event to loans.log</li>
							<li>All operations performed atomically (within a database transaction)</li>
						</ol>
						<p><strong>Manual Actions Required:</strong></p>
						<ul>
							<li><strong>Monitoring only</strong> - Ensure daily tasks complete successfully</li>
							<li>Review logs for any errors during maturity processing</li>
							<li>Clients should be notified 30 days before maturity to ensure adequate chequing balance</li>
						</ul>
						<div class="alert alert-warning alert-process">
							<strong>Critical:</strong> At maturity, the system automatically withdraws any unpaid balance from the client's chequing account. If the account has insufficient funds, it will go negative. Admins should monitor the "Maturing Accounts" dashboard notification and contact clients to ensure adequate funds.
						</div>
					</div>

					<h4>GIC/Investment Maturity Process (Fully Automated)</h4>
					<div class="process-step">
						<p><strong>When:</strong> Start Date + Term (in months) = Maturity Date</p>
						<p><strong>Automatic Actions:</strong></p>
						<ol>
							<li>System logs <code>GIC_MATURITY</code> event to <code>./var/log/gic.log</code></li>
							<li>Calculates maturity value using <strong>compound interest with monthly compounding</strong>:
								<div class="code-block">
									Maturity Value = Principal × (1 + Annual Rate / 12)<sup>Term in Months</sup>
								</div>
							</li>
							<li>Deposits full maturity value to client's <strong>chequing account</strong></li>
							<li>Updates GIC status to <span class="badge bg-secondary">CLOSED</span></li>
							<li>Logs <code>GIC_PAYOFF</code> event with maturity value and interest earned</li>
							<li>All operations performed atomically (within a database transaction)</li>
						</ol>
						<p><strong>Manual Actions Required:</strong></p>
						<ul>
							<li><strong>None</strong> - GIC maturity is fully automated</li>
							<li>Admin should monitor for any errors in the automated process</li>
						</ul>
						<div class="alert alert-success alert-process">
							<strong>Example:</strong> $5,000 GIC at 3% APR for 12 months<br>
							Maturity Value = $5,000 × (1 + 0.03/12)<sup>12</sup> = $5,152.02<br>
							Interest Earned = $152.02<br>
							$5,152.02 is automatically deposited to client's chequing account
						</div>
					</div>
				</div>

				<!-- Account Status Guide -->
				<div class="help-section">
					<h3><i data-feather="tag"></i> Account Status Guide</h3>

					<h4>Loan Statuses and Lifecycle</h4>
					<div class="process-step">
						<p><strong>Status Progression:</strong></p>
						<ul>
							<li><span class="badge bg-warning">PENDING</span> - Awaiting admin approval (new loan request)
								<ul class="mt-2">
									<li>Client submits loan application</li>
									<li>No funds disbursed yet</li>
								</ul>
							</li>
							<li><span class="badge bg-success">Active</span> - Loan approved and active
								<ul class="mt-2">
									<li><strong>After approval:</strong> Funds disbursed the day after start date during daily tasks</li>
									<li>Interest payments begin after disbursement, based on payment frequency</li>
									<li>Loan remains active until paid off or matured</li>
								</ul>
							</li>
							<li><span class="badge bg-danger">REJECTED</span> - Loan request denied by admin
								<ul class="mt-2">
									<li>No funds are disbursed</li>
									<li>Client must submit a new application</li>
								</ul>
							</li>
							<li><span class="badge bg-success">PAID_OFF</span> - Loan fully paid before maturity, no longer processing payments
								<ul class="mt-2">
									<li>Client deposited enough to cover the principal</li>
									<li>Automatically marked when balance ≥ principal</li>
								</ul>
							</li>
							<li><span class="badge bg-secondary">CLOSED</span> - Loan has reached maturity and final payment processed
								<ul class="mt-2">
									<li>Maturity date reached</li>
									<li>Remaining balance withdrawn from chequing</li>
									<li>Loan account closed</li>
								</ul>
							</li>
						</ul>
					</div>

					<h4>GIC Statuses</h4>
					<div class="process-step">
						<ul>
							<li><span class="badge bg-success">Active</span> - Active investment (interest calculated at maturity, not daily)</li>
							<li><span class="badge bg-secondary">CLOSED</span> - GIC has matured and funds returned to chequing</li>
						</ul>
					</div>
				</div>

				<!-- Daily Workflow Section -->
				<div class="help-section">
					<h3><i data-feather="check-circle"></i> Recommended Daily Admin Workflow</h3>

					<div class="process-step">
						<h4>Morning Review (9:00 AM)</h4>
						<ol>
							<li><strong>Check Dashboard Notifications:</strong>
								<ul>
									<li>Review pending transactions at <a href="/admin/transactions">/admin/transactions</a></li>
									<li>Review pending loan requests at <a href="/admin/loans/requests">/admin/loans/requests</a></li>
									<li>Review maturing accounts (loans and GICs within 30 days)</li>
								</ul>
							</li>
							<li><strong>Process Pending Transactions:</strong>
								<ul>
									<li>Approve or reject client-initiated transactions</li>
									<li>Verify transaction details and amounts</li>
								</ul>
							</li>
							<li><strong>Process Loan Requests:</strong>
								<ul>
									<li>Review client credit history and account status</li>
									<li>Verify client's chequing account exists</li>
									<li>Approve or deny loan requests</li>
									<li><strong>Important:</strong> When approved:
										<ul>
											<li>Loan status changes to APPROVED immediately</li>
											<li>Funds will be disbursed on start date during midnight daily tasks</li>
											<li>Can approve loans in advance of their start date</li>
										</ul>
									</li>
								</ul>
							</li>
						</ol>

						<h4>End of Day Review (5:00 PM)</h4>
						<ol>
							<li><strong>Review Maturing Loans:</strong>
								<ul>
									<li>Contact clients with loans maturing soon</li>
									<li>Follow up on loans past maturity that are not paid off</li>
								</ul>
							</li>
							<li><strong>Monitor System Health:</strong>
								<ul>
									<li>Check server logs for any errors in daily tasks</li>
									<li>Verify automated interest calculations completed successfully</li>
								</ul>
							</li>
						</ol>

						<h4>Monthly Review</h4>
						<ol>
							<li>Review all active loans and investments</li>
							<li>Generate reports on interest accrued and paid</li>
							<li>Review client accounts for any anomalies</li>
							<li>Update GIC product offerings and interest rates as needed</li>
						</ol>
					</div>
				</div>

				<!-- Important URLs Section -->
				<div class="help-section">
					<h3><i data-feather="link"></i> Important Admin Links</h3>

					<div class="process-step">
						<h4>Transaction Management</h4>
						<ul>
							<li><a href="/admin/transactions">/admin/transactions</a> - Review and approve pending transactions</li>
						</ul>

						<h4>Loan Management</h4>
						<ul>
							<li><a href="/admin/loans/view">/admin/loans/view</a> - View loans by client</li>
							<li><a href="/admin/loans/requests">/admin/loans/requests</a> - Review pending loan requests</li>
							<li><a href="/admin/loans/add">/admin/loans/add</a> - Create a new loan</li>
						</ul>

						<h4>Investment (GIC) Management</h4>
						<ul>
							<li><a href="/admin/gics/view">/admin/gics/view</a> - View and manage GIC products</li>
							<li><a href="/admin/gics/add">/admin/gics/add</a> - Create a new GIC product</li>
						</ul>

						<h4>Client Management</h4>
						<ul>
							<li><a href="/admin/clients">/admin/clients</a> - View and edit client information</li>
							<li><a href="/admin/agreements/view">/admin/agreements/view</a> - View client agreements</li>
						</ul>
					</div>
				</div>

				<!-- Technical Details Section -->
				<div class="help-section">
					<h3><i data-feather="cpu"></i> Technical Details</h3>

					<div class="process-step">
						<h4>Interest Calculation Methods</h4>
						<p><strong>Loan Interest Payments:</strong> Based on payment frequency (not daily accrual)</p>
						<div class="code-block">
							Monthly Interest = (Principal × Annual Rate / 100) / 12<br>
							Annual Interest = Principal × Annual Rate / 100
						</div>
						<p class="text-muted small">Payments are withdrawn from chequing account on the anniversary day each month/year.</p>

						<p class="mt-3"><strong>GIC Maturity Value:</strong> Compound Interest (monthly compounding)</p>
						<div class="code-block">
							Maturity Value = Principal × (1 + Annual Rate / 12)<sup>Term in Months</sup><br>
							Interest Earned = Maturity Value - Principal
						</div>
						<p class="text-muted small">Interest is NOT calculated daily; it's only computed at maturity using compound interest.</p>

						<h4 class="mt-4">Maturity Date Calculation</h4>
						<div class="code-block">
							Maturity Date = Start Date + Term (in months)<br>
							Example: Jan 15, 2024 + 12 months = Jan 15, 2025
						</div>

						<h4 class="mt-4">Payment Frequency Logic</h4>
						<div class="code-block">
							Monthly: Payment on same day each month (e.g., 15th of every month)<br>
							Annual: Payment on same date each year (e.g., Jan 15 annually)<br>
							<br>
							Check: monthsElapsed > 0 AND today.date === startDate.date
						</div>

						<h4 class="mt-4">Cron Schedule</h4>
						<div class="code-block">
							Schedule: 0 0 * * * (Every day at midnight UTC)<br>
							Location: /jobs/dailyTasks.js<br>
							Loaded in: /app.js line 14
						</div>

						<h4 class="mt-4">Log Files</h4>
						<ul>
							<li><code>./var/log/loans.log</code> - Complete loan lifecycle events:
								<ul>
									<li><strong>LOAN_APPROVED:</strong> When admin approves loan (includes principal, rate, term, start date, frequency)</li>
									<li><strong>LOAN_DISBURSED:</strong> When funds deposited to chequing on start date</li>
									<li><strong>LOAN_MATURITY:</strong> When loan reaches maturity date (includes balance paid, remaining)</li>
									<li><strong>LOAN_CLOSED:</strong> When loan is closed after maturity processing</li>
								</ul>
							</li>
							<li><code>./var/log/gic.log</code> - Complete GIC lifecycle events:
								<ul>
									<li><strong>GIC_PURCHASED:</strong> When client purchases GIC (includes product, principal, rate, term)</li>
									<li><strong>GIC_MATURITY:</strong> When GIC reaches maturity date</li>
									<li><strong>GIC_PAYOFF:</strong> When funds deposited to chequing (includes maturity value, interest earned)</li>
								</ul>
							</li>
						</ul>

						<h4 class="mt-4">Key Service Files</h4>
						<ul>
							<li><code>/services/loan.service.js</code> - Loan business logic and interest processing</li>
							<li><code>/services/gic.service.js</code> - GIC/investment business logic</li>
							<li><code>/services/financial.service.js</code> - Financial calculations and maturity checks</li>
							<li><code>/services/maturity-logger.service.js</code> - Unified logging for maturity events</li>
							<li><code>/jobs/dailyTasks.js</code> - Automated daily processes</li>
						</ul>
					</div>
				</div>
			</div>
		</main>
		<footer>
			<%- include('partials/footer'); %>
		</footer>

		<!-- Icons -->
		<script src="/js/feather.min.js"></script>
		<script>feather.replace()</script>
	</body>
</html>
